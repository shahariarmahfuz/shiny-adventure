{% extends "layout.html" %}
{% block content %}
  <h1>Message</h1>

  <p class="muted">Mailbox: <code>{{ msg.mailbox_address }}</code></p>

  <div class="card">
    <div class="kv">
      <div class="k">ID</div><div class="v mono">{{ msg.id }}</div>

      <div class="k">Envelope From</div><div class="v mono">{{ msg.envelope_from }}</div>
      <div class="k">Envelope To</div><div class="v mono">{{ msg.envelope_to }}</div>

      <div class="k">Subject</div><div class="v">{{ msg.subject or "(no subject)" }}</div>
      <div class="k">Received</div><div class="v"><code>{{ msg.received_at }}</code></div>

      <div class="k">Parsed From</div><div class="v mono">{{ msg.parsed_from or "-" }}</div>
      <div class="k">Parsed To</div><div class="v mono">{{ msg.parsed_to or "-" }}</div>
      <div class="k">Parsed Date</div><div class="v mono">{{ msg.parsed_date or "-" }}</div>

      <div class="k">Raw</div>
      <div class="v">
        <a class="btn" href="{{ url_for('download_raw', msg_id=msg.id) }}"><i class="ri-download-2-line"></i> Download .eml</a>
      </div>
    </div>
  </div>

  <form method="post" action="{{ url_for('delete_message', msg_id=msg.id) }}" class="danger" id="delete-message-form">
    <button class="btn btn-danger" type="button" data-confirm="delete-message">
      <i class="ri-delete-bin-6-line"></i> Delete message
    </button>
  </form>

  <div class="modal" id="confirm-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-icon"><i class="ri-alert-line"></i></div>
      <h3 id="modal-title">Delete message?</h3>
      <p id="modal-message" class="muted">This will permanently delete the message from the server.</p>
      <div class="modal-actions">
        <button class="btn" type="button" data-close-modal>Cancel</button>
        <button class="btn btn-danger" type="button" id="modal-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById("confirm-modal");
    const modalConfirm = document.getElementById("modal-confirm");
    const closeModalButtons = modal.querySelectorAll("[data-close-modal]");
    let submitTarget = null;

    function openModal() {
      submitTarget = document.getElementById("delete-message-form");
      modal.setAttribute("aria-hidden", "false");
      modal.classList.add("open");
    }

    function closeModal() {
      modal.setAttribute("aria-hidden", "true");
      modal.classList.remove("open");
      submitTarget = null;
    }

    document.querySelectorAll("[data-confirm]").forEach((btn) => {
      btn.addEventListener("click", openModal);
    });

    modalConfirm.addEventListener("click", () => {
      if (submitTarget) {
        submitTarget.submit();
      }
    });

    closeModalButtons.forEach((btn) => btn.addEventListener("click", closeModal));
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
{% endblock %}
